<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beenode OS</title>
  <style>
    :root {
      --wallpaper: #0a0a1a;
      --grid-line: rgba(255, 255, 255, 0.035);
      --text-primary: #eef1ff;
      --text-muted: #9aa4c7;
      --accent: #f7b731;
      --glass: rgba(20, 28, 48, 0.55);
      --glass-strong: rgba(16, 22, 36, 0.82);
      --glass-border: rgba(255, 255, 255, 0.12);
      --shadow: rgba(0, 0, 0, 0.4);
      --phi: 1.618034;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'SF Pro Display', 'SF Mono', Monaco, 'Cascadia Code', sans-serif;
      color: var(--text-primary);
      background-color: var(--wallpaper);
      background-image:
        linear-gradient(var(--grid-line) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
      background-size: 48px 48px;
      overflow: hidden;
    }
    .os-shell {
      position: relative;
      height: 100vh;
      width: 100vw;
    }
    .status-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      font-size: 12px;
      color: var(--text-muted);
      backdrop-filter: blur(10px);
      background: rgba(8, 10, 20, 0.55);
      z-index: 10;
    }
    .status-center { font-variant-numeric: tabular-nums; }
    .network-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      background: #e74c3c;
      box-shadow: 0 0 8px rgba(231, 76, 60, 0.8);
    }
    .network-dot.ok {
      background: #27ae60;
      box-shadow: 0 0 8px rgba(39, 174, 96, 0.8);
    }
    .desktop {
      height: 100%;
      padding: 48px 48px 120px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }
    .desktop-grid {
      display: grid;
      grid-template-columns: repeat(4, 96px);
      gap: 32px 24px;
    }
    .desktop-icon {
      background: none;
      border: none;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .desktop-icon span:first-child {
      font-size: 32px;
      width: 64px;
      height: 64px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(8px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 20px var(--shadow);
    }
    .desktop-icon span:last-child { color: var(--text-muted); }
    .dock {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      height: 60px;
      padding: 0 18px;
      display: flex;
      align-items: center;
      gap: 16px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      backdrop-filter: blur(18px);
      box-shadow: 0 16px 30px var(--shadow);
      z-index: 9;
    }
    .dock-icon {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid transparent;
      font-size: 22px;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: transform 0.15s ease, border 0.15s ease;
    }
    .dock-icon.active {
      border-color: var(--accent);
      transform: translateY(-4px);
    }
    .dock-icon.open::after {
      content: '';
      position: absolute;
      bottom: -6px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(247, 183, 49, 0.6);
    }
    .window-layer {
      position: absolute;
      inset: 0;
      display: none;
      padding: 60px 40px 120px;
      background: rgba(5, 8, 18, 0.35);
      z-index: 8;
    }
    .window-layer.active { display: block; }
    .window {
      position: absolute;
      min-width: 400px;
      min-height: 300px;
      max-width: 80vw;
      max-height: 80vh;
      background: var(--glass-strong);
      border: 1px solid var(--glass-border);
      border-radius: 18px;
      backdrop-filter: blur(20px);
      box-shadow: 0 24px 40px var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transform: translateY(12px) scale(0.985);
      transition: all 0.2s ease;
    }
    .window.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
    }
    .window.minimized {
      opacity: 0;
      pointer-events: none;
      transform: translateY(16px) scale(0.98);
    }
    .window-title {
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      padding: 0 14px;
      background: rgba(10, 14, 24, 0.7);
      border-bottom: 1px solid var(--glass-border);
      cursor: grab;
    }
    .window-title span { font-size: 14px; color: var(--text-muted); }
    .window-controls { display: flex; gap: 8px; }
    .window-controls button {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: none;
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease, color 0.15s ease, transform 0.15s ease;
    }
    .window-controls button:hover { transform: translateY(-1px); }
    .close-button { background: rgba(231, 76, 60, 0.18); }
    .maximize-button { background: rgba(46, 204, 113, 0.15); }
    .minimize-button { background: rgba(247, 183, 49, 0.18); }
    .minimize-button:hover {
      background: rgba(247, 183, 49, 0.4);
      color: #1a1a2e;
    }
    .maximize-button:hover {
      background: rgba(46, 204, 113, 0.35);
      color: #1a1a2e;
    }
    .close-button:hover {
      background: rgba(231, 76, 60, 0.45);
      color: #fff;
    }
    .window-content {
      flex: 1;
      padding: 16px 20px;
      overflow: auto;
    }
    .resize-handle {
      position: absolute;
      z-index: 3;
      background: transparent;
    }
    .resize-handle.n,
    .resize-handle.s {
      left: 14px;
      right: 14px;
      height: 8px;
      cursor: ns-resize;
    }
    .resize-handle.e,
    .resize-handle.w {
      top: 14px;
      bottom: 14px;
      width: 8px;
      cursor: ew-resize;
    }
    .resize-handle.n { top: -4px; }
    .resize-handle.s { bottom: -4px; }
    .resize-handle.e { right: -4px; }
    .resize-handle.w { left: -4px; }
    .resize-handle.ne,
    .resize-handle.nw,
    .resize-handle.se,
    .resize-handle.sw {
      width: 14px;
      height: 14px;
    }
    .resize-handle.ne { top: -4px; right: -4px; cursor: nesw-resize; }
    .resize-handle.nw { top: -4px; left: -4px; cursor: nwse-resize; }
    .resize-handle.se { bottom: -4px; right: -4px; cursor: nwse-resize; }
    .resize-handle.sw { bottom: -4px; left: -4px; cursor: nesw-resize; }
    h1 { margin: 0; font-size: 22px; color: var(--text-primary); }
    h3 { color: var(--accent); margin: 0 0 0.5em 0; }
    .subtitle { color: var(--text-muted); margin: 6px 0 12px; }
    .card {
      background: rgba(18, 24, 40, 0.65);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 0.8em;
      margin: 0 0 0.6em 0;
      box-shadow: 0 12px 24px var(--shadow);
    }
    button {
      background: var(--accent);
      color: #1a1a2e;
      border: none;
      padding: 0.55em 1.2em;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      margin: 0.25em 0.35em 0.25em 0;
    }
    button:hover { filter: brightness(1.05); }
    button:disabled { background: #555; cursor: not-allowed; }
    pre {
      background: rgba(9, 14, 28, 0.9);
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 1em 0 0 0;
      min-height: 50px;
    }
    input {
      background: rgba(10, 15, 28, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      padding: 0.6em;
      border-radius: 8px;
      font-family: inherit;
      width: 100%;
      max-width: 400px;
      margin: 0.25em 0;
    }
    input:focus { outline: 1px solid var(--accent); }
    label { display: block; margin: 0.5em 0 0.25em 0; color: var(--text-muted); }
    .status { display: inline-block; padding: 0.25em 0.5em; border-radius: 6px; font-size: 0.8em; }
    .status.ok { background: #27ae60; }
    .status.error { background: #e74c3c; }
    .balance { font-size: 2em; color: var(--accent); }
    .sats { font-size: 0.5em; color: var(--text-muted); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75em; }
    @media (max-width: 700px) {
      .desktop { padding: 48px 24px 120px; }
      .desktop-grid { grid-template-columns: repeat(2, 96px); }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="os-shell">
    <div class="status-bar">
      <div class="status-left">Beenode OS</div>
      <div class="status-center" id="clock">--:--</div>
      <div class="status-right"><span id="network-dot" class="network-dot"></span></div>
    </div>

    <main class="desktop">
      <div class="desktop-grid">
        <button class="desktop-icon" data-app="home"><span>üè†</span><span>Home</span></button>
        <button class="desktop-icon" data-app="wallet"><span>üí∞</span><span>Wallet</span></button>
        <button class="desktop-icon" data-app="scrolls"><span>üìú</span><span>Scrolls</span></button>
        <button class="desktop-icon" data-app="settings"><span>‚öôÔ∏è</span><span>Settings</span></button>
      </div>
    </main>

    <div class="window-layer" id="window-layer">
      <div class="window" data-app-window="home">
        <div class="window-title" data-drag-handle>
          <div class="window-controls">
            <button class="minimize-button" data-minimize>‚àí</button>
            <button class="maximize-button" data-maximize>‚ñ°</button>
            <button class="close-button" data-close>‚úï</button>
          </div>
          <span>Home</span>
        </div>
        <div class="window-content">
          <h1>Welcome back</h1>
          <p class="subtitle">Your Beenode desktop is synced and ready.</p>
          <div class="card">
            <h3>Quick Actions</h3>
            <button onclick="checkHealth()">Check Health</button>
            <button onclick="syncWallet()">Sync Wallet</button>
            <button onclick="getBalance()">Refresh Balance</button>
          </div>
          <div class="card">
            <h3>System Status</h3>
            <div id="health-status"></div>
            <pre id="health-result">Click "Check Health" to connect</pre>
          </div>
        </div>
        <div class="resize-handle n" data-resize="n"></div>
        <div class="resize-handle s" data-resize="s"></div>
        <div class="resize-handle e" data-resize="e"></div>
        <div class="resize-handle w" data-resize="w"></div>
        <div class="resize-handle ne" data-resize="ne"></div>
        <div class="resize-handle nw" data-resize="nw"></div>
        <div class="resize-handle se" data-resize="se"></div>
        <div class="resize-handle sw" data-resize="sw"></div>
      </div>

      <div class="window" data-app-window="wallet">
        <div class="window-title" data-drag-handle>
          <div class="window-controls">
            <button class="minimize-button" data-minimize>‚àí</button>
            <button class="maximize-button" data-maximize>‚ñ°</button>
            <button class="close-button" data-close>‚úï</button>
          </div>
          <span>Wallet</span>
        </div>
        <div class="window-content">
          <div class="card">
            <h3>Balance</h3>
            <div class="balance" id="balance-display">-- <span class="sats">sats</span></div>
            <button onclick="getBalance()">Refresh Balance</button>
          </div>

          <div class="grid">
            <div class="card">
              <h3>Receive Address</h3>
              <button onclick="getAddress()">Get New Address</button>
              <pre id="address-result">Click to generate</pre>
            </div>

            <div class="card">
              <h3>Send Bitcoin</h3>
              <label>To Address:</label>
              <input id="send-to" placeholder="bcrt1q...">
              <label>Amount (sats):</label>
              <input id="send-amount" type="number" value="10000">
              <button onclick="sendTx()">Send Transaction</button>
              <pre id="send-result"></pre>
            </div>
          </div>

          <div class="card">
            <h3>Recent Transactions</h3>
            <button onclick="getTxs()">Load Transactions</button>
            <pre id="txs-result">Click to load</pre>
          </div>
        </div>
        <div class="resize-handle n" data-resize="n"></div>
        <div class="resize-handle s" data-resize="s"></div>
        <div class="resize-handle e" data-resize="e"></div>
        <div class="resize-handle w" data-resize="w"></div>
        <div class="resize-handle ne" data-resize="ne"></div>
        <div class="resize-handle nw" data-resize="nw"></div>
        <div class="resize-handle se" data-resize="se"></div>
        <div class="resize-handle sw" data-resize="sw"></div>
      </div>

      <div class="window" data-app-window="scrolls">
        <div class="window-title" data-drag-handle>
          <div class="window-controls">
            <button class="minimize-button" data-minimize>‚àí</button>
            <button class="maximize-button" data-maximize>‚ñ°</button>
            <button class="close-button" data-close>‚úï</button>
          </div>
          <span>Scrolls</span>
        </div>
        <div class="window-content">
          <div class="card">
            <h3>Scroll Browser</h3>
            <input id="scroll-path" value="/wallet/status" placeholder="/path">
            <button onclick="getScroll()">GET</button>
            <button onclick="listScrolls()">LIST</button>
            <pre id="scroll-result">Enter a path and click GET or LIST</pre>
          </div>
        </div>
        <div class="resize-handle n" data-resize="n"></div>
        <div class="resize-handle s" data-resize="s"></div>
        <div class="resize-handle e" data-resize="e"></div>
        <div class="resize-handle w" data-resize="w"></div>
        <div class="resize-handle ne" data-resize="ne"></div>
        <div class="resize-handle nw" data-resize="nw"></div>
        <div class="resize-handle se" data-resize="se"></div>
        <div class="resize-handle sw" data-resize="sw"></div>
      </div>

      <div class="window" data-app-window="settings">
        <div class="window-title" data-drag-handle>
          <div class="window-controls">
            <button class="minimize-button" data-minimize>‚àí</button>
            <button class="maximize-button" data-maximize>‚ñ°</button>
            <button class="close-button" data-close>‚úï</button>
          </div>
          <span>Settings</span>
        </div>
        <div class="window-content">
          <div class="card">
            <h3>Appearance</h3>
            <p class="subtitle">Themes, dock preferences, and wallpaper controls land here.</p>
            <button disabled>Coming soon</button>
          </div>
        </div>
        <div class="resize-handle n" data-resize="n"></div>
        <div class="resize-handle s" data-resize="s"></div>
        <div class="resize-handle e" data-resize="e"></div>
        <div class="resize-handle w" data-resize="w"></div>
        <div class="resize-handle ne" data-resize="ne"></div>
        <div class="resize-handle nw" data-resize="nw"></div>
        <div class="resize-handle se" data-resize="se"></div>
        <div class="resize-handle sw" data-resize="sw"></div>
      </div>
    </div>

    <nav class="dock">
      <button class="dock-icon" data-app="home" title="Home">üè†</button>
      <button class="dock-icon" data-app="wallet" title="Wallet">üí∞</button>
      <button class="dock-icon" data-app="scrolls" title="Scrolls">üìú</button>
      <button class="dock-icon" data-app="settings" title="Settings">‚öôÔ∏è</button>
    </nav>
  </div>

  <script>
    // API base - use /api/ prefix which nginx proxies to beenode
    const API = '/api';

    async function api(method, path, body) {
      try {
        const opts = {
          method,
          headers: { 'Content-Type': 'application/json' }
        };
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch(API + path, opts);
        const data = await res.json();
        return { ok: res.ok, data };
      } catch (e) {
        return { ok: false, data: { error: e.message } };
      }
    }

    async function checkHealth() {
      const el = document.getElementById('health-result');
      el.textContent = 'Checking...';
      const r = await api('GET', '/health');
      document.getElementById('health-status').innerHTML = r.ok
        ? '<span class="status ok">Connected</span>'
        : '<span class="status error">Disconnected</span>';
      const dot = document.getElementById('network-dot');
      if (dot) {
        dot.classList.toggle('ok', r.ok);
      }
      el.textContent = JSON.stringify(r.data, null, 2);
      if (r.ok) getBalance();
    }

    async function getBalance() {
      const el = document.getElementById('balance-display');
      const r = await api('GET', '/scroll/wallet/balance');
      if (r.ok && r.data.data) {
        const b = r.data.data;
        el.innerHTML = `${b.confirmed.toLocaleString()} <span class="sats">sats</span>`;
        if (b.pending > 0) {
          el.innerHTML += ` <span style="color:#888">(+${b.pending} pending)</span>`;
        }
      } else {
        el.innerHTML = `<span style="color:#e74c3c">Error</span>`;
      }
    }

    async function syncWallet() {
      const el = document.getElementById('health-result');
      el.textContent = 'Syncing wallet...';
      const r = await api('POST', '/scroll/wallet/sync', {});
      el.textContent = JSON.stringify(r.data, null, 2);
      setTimeout(getBalance, 1000);
    }

    async function getAddress() {
      const el = document.getElementById('address-result');
      el.textContent = 'Generating...';
      const r = await api('GET', '/scroll/wallet/address');
      if (r.ok && r.data.data) {
        el.textContent = r.data.data.address;
      } else {
        el.textContent = JSON.stringify(r.data, null, 2);
      }
    }

    async function sendTx() {
      const to = document.getElementById('send-to').value;
      const amount = parseInt(document.getElementById('send-amount').value);
      const el = document.getElementById('send-result');

      if (!to || !amount) {
        el.textContent = 'Please fill in address and amount';
        return;
      }

      el.textContent = 'Sending...';
      const r = await api('POST', '/scroll/wallet/send', { to, amount_sat: amount });
      el.textContent = JSON.stringify(r.data, null, 2);
      if (r.ok) {
        setTimeout(getBalance, 2000);
      }
    }

    async function getTxs() {
      const el = document.getElementById('txs-result');
      el.textContent = 'Loading...';
      const r = await api('GET', '/scroll/wallet/transactions');
      if (r.ok && r.data.data) {
        const txs = r.data.data.transactions || [];
        if (txs.length === 0) {
          el.textContent = 'No transactions yet';
        } else {
          el.textContent = txs.map(tx =>
            `${tx.txid.slice(0,8)}... ${tx.sent > 0 ? '-' : '+'}${Math.abs(tx.received - tx.sent)} sats`
          ).join('\n');
        }
      } else {
        el.textContent = JSON.stringify(r.data, null, 2);
      }
    }

    async function getScroll() {
      const path = document.getElementById('scroll-path').value;
      const el = document.getElementById('scroll-result');
      el.textContent = 'Loading...';
      const r = await api('GET', '/scroll' + path);
      el.textContent = JSON.stringify(r.data, null, 2);
    }

    async function listScrolls() {
      const path = document.getElementById('scroll-path').value;
      const el = document.getElementById('scroll-result');
      el.textContent = 'Loading...';
      const r = await api('GET', '/scrolls?prefix=' + encodeURIComponent(path));
      el.textContent = JSON.stringify(r.data, null, 2);
    }

    function updateClock() {
      const el = document.getElementById('clock');
      if (!el) return;
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      el.textContent = `${hours}:${minutes}`;
    }

    const PHI = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--phi')) || 1.618034;
    const WINDOW_MIN_WIDTH = 400;
    const WINDOW_MIN_HEIGHT = 300;
    const WINDOW_MAX_RATIO = 0.8;
    const WINDOW_CONTENT_PADDING = 32;
    const windowLayer = document.getElementById('window-layer');
    const windowElements = Array.from(document.querySelectorAll('[data-app-window]'));
    let openWindowOrder = [];
    let activeAppId = null;
    let zIndexCounter = 20;

    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }

    function getDefaultWindowSize() {
      return { width: WINDOW_MIN_WIDTH, height: WINDOW_MIN_HEIGHT };
    }

    function getMaxWindowSize(bounds = getBounds()) {
      return {
        width: Math.max(WINDOW_MIN_WIDTH, Math.round(bounds.width * WINDOW_MAX_RATIO)),
        height: Math.max(WINDOW_MIN_HEIGHT, Math.round(bounds.height * WINDOW_MAX_RATIO))
      };
    }

    function getBounds() {
      if (!windowLayer) {
        return { width: window.innerWidth, height: window.innerHeight };
      }
      return windowLayer.getBoundingClientRect();
    }

    function getWindowKey(appId) {
      return `beenode.window.size.${appId}`;
    }

    function getStoredSize(appId) {
      const raw = localStorage.getItem(getWindowKey(appId));
      if (!raw) return null;
      try {
        const parsed = JSON.parse(raw);
        if (!parsed || !parsed.width || !parsed.height) return null;
        return parsed;
      } catch (e) {
        return null;
      }
    }

    function saveWindowSize(windowEl) {
      const appId = windowEl.getAttribute('data-app-window');
      if (!appId || windowEl.dataset.state === 'maximized') return;
      const width = Math.round(windowEl.offsetWidth);
      const height = Math.round(windowEl.offsetHeight);
      localStorage.setItem(getWindowKey(appId), JSON.stringify({ width, height }));
    }

    function applyWindowContentSizing(windowEl, height) {
      const title = windowEl.querySelector('.window-title');
      const content = windowEl.querySelector('.window-content');
      if (!title || !content) return;
      const contentHeight = Math.max(height - title.offsetHeight, 0);
      content.style.maxHeight = `${contentHeight}px`;
      content.style.overflowY = content.scrollHeight > contentHeight ? 'auto' : 'hidden';
    }

    function fitWindowToContent(windowEl) {
      if (!windowEl || windowEl.dataset.state === 'maximized') return;
      const bounds = getBounds();
      const content = windowEl.querySelector('.window-content');
      const title = windowEl.querySelector('.window-title');
      if (!content || !title) return;

      const { width: minWidth, height: minHeight } = getDefaultWindowSize(bounds);
      const { width: maxWidth, height: maxHeight } = getMaxWindowSize(bounds);

      const desiredWidth = clamp(
        Math.max(content.scrollWidth + WINDOW_CONTENT_PADDING, minWidth),
        minWidth,
        maxWidth
      );
      const desiredHeight = clamp(
        Math.max(content.scrollHeight + title.offsetHeight + WINDOW_CONTENT_PADDING, minHeight),
        minHeight,
        maxHeight
      );

      windowEl.style.width = `${desiredWidth}px`;
      windowEl.style.height = `${desiredHeight}px`;
      applyWindowContentSizing(windowEl, desiredHeight);
      saveWindowSize(windowEl);
    }

    function applyStoredWindowSize(windowEl) {
      const appId = windowEl.getAttribute('data-app-window');
      if (!appId) return false;
      const stored = getStoredSize(appId);
      if (!stored) return false;
      const bounds = getBounds();
      const { width: minWidth, height: minHeight } = getDefaultWindowSize(bounds);
      const { width: maxWidth, height: maxHeight } = getMaxWindowSize(bounds);
      const width = clamp(stored.width, minWidth, maxWidth);
      const height = clamp(stored.height, minHeight, maxHeight);
      windowEl.style.width = `${width}px`;
      windowEl.style.height = `${height}px`;
      applyWindowContentSizing(windowEl, height);
      windowEl.dataset.userSized = 'true';
      return true;
    }

    function positionWindow(windowEl) {
      if (!windowEl || windowEl.dataset.state === 'maximized' || windowEl.dataset.userPositioned === 'true') return;
      const bounds = getBounds();
      const width = windowEl.offsetWidth;
      const height = windowEl.offsetHeight;
      const centerX = (bounds.width - width) / 2;
      const centerY = (bounds.height - height) / 2;
      const margin = 20;

      const left = clamp(centerX, margin, bounds.width - width - margin);
      const top = clamp(centerY, margin, bounds.height - height - margin);

      windowEl.style.left = `${left}px`;
      windowEl.style.top = `${top}px`;
    }

    function layoutWindow(windowEl) {
      if (!windowEl) return;
      if (!applyStoredWindowSize(windowEl)) {
        fitWindowToContent(windowEl);
        windowEl.dataset.userSized = 'false';
      }
      positionWindow(windowEl);
    }

    function bringToFront(windowEl) {
      if (!windowEl) return;
      zIndexCounter += 1;
      windowEl.style.zIndex = zIndexCounter;
      activeAppId = windowEl.getAttribute('data-app-window');
      updateDockIndicators();
    }

    function updateDockIndicators() {
      const openApps = new Set(openWindowOrder);
      document.querySelectorAll('.dock-icon').forEach((btn) => {
        const appId = btn.getAttribute('data-app');
        btn.classList.toggle('open', openApps.has(appId));
        btn.classList.toggle('active', appId === activeAppId);
      });
    }

    function openApp(appId) {
      const windowEl = document.querySelector(`[data-app-window="${appId}"]`);
      if (!windowEl || !windowLayer) return;
      if (!windowEl.classList.contains('active')) {
        windowEl.classList.add('active');
        windowEl.classList.remove('minimized');
        if (!openWindowOrder.includes(appId)) openWindowOrder.push(appId);
        windowEl.dataset.state = 'normal';
        layoutWindow(windowEl);
      } else if (windowEl.classList.contains('minimized')) {
        windowEl.classList.remove('minimized');
        windowEl.dataset.state = 'normal';
        bringToFront(windowEl);
      }
      windowLayer.classList.add('active');
      bringToFront(windowEl);
    }

    function closeWindow(windowEl) {
      if (!windowEl) return;
      const appId = windowEl.getAttribute('data-app-window');
      windowEl.classList.remove('minimized');
      windowEl.classList.remove('active');
      openWindowOrder = openWindowOrder.filter((id) => id !== appId);
      const remaining = windowElements.filter((win) => win.classList.contains('active'));
      if (remaining.length === 0 && windowLayer) {
        windowLayer.classList.remove('active');
        activeAppId = null;
      } else {
        let topWindow = null;
        let topZ = -1;
        remaining.forEach((win) => {
          const z = parseInt(win.style.zIndex || '0', 10);
          if (z > topZ) {
            topZ = z;
            topWindow = win;
          }
        });
        activeAppId = topWindow ? topWindow.getAttribute('data-app-window') : null;
      }
      updateDockIndicators();
    }

    function minimizeWindow(windowEl) {
      if (!windowEl) return;
      const appId = windowEl.getAttribute('data-app-window');
      if (!appId) return;
      windowEl.classList.add('minimized');
      windowEl.dataset.state = 'minimized';
      const remaining = windowElements.filter((win) =>
        win.classList.contains('active') && !win.classList.contains('minimized')
      );
      if (remaining.length === 0 && windowLayer) {
        windowLayer.classList.remove('active');
        activeAppId = null;
      } else {
        let topWindow = null;
        let topZ = -1;
        remaining.forEach((win) => {
          const z = parseInt(win.style.zIndex || '0', 10);
          if (z > topZ) {
            topZ = z;
            topWindow = win;
          }
        });
        activeAppId = topWindow ? topWindow.getAttribute('data-app-window') : null;
      }
      updateDockIndicators();
    }

    function maximizeWindow(windowEl) {
      if (!windowEl || windowEl.dataset.state === 'maximized') return;
      windowEl.classList.remove('minimized');
      const bounds = getBounds();
      const margin = 20;
      const rect = {
        left: windowEl.offsetLeft,
        top: windowEl.offsetTop,
        width: windowEl.offsetWidth,
        height: windowEl.offsetHeight
      };
      windowEl.dataset.normalRect = JSON.stringify(rect);
      windowEl.dataset.state = 'maximized';
      windowEl.style.left = `${margin}px`;
      windowEl.style.top = `${margin}px`;
      windowEl.style.width = `${Math.max(bounds.width - margin * 2, 0)}px`;
      windowEl.style.height = `${Math.max(bounds.height - margin * 2, 0)}px`;
      applyWindowContentSizing(windowEl, windowEl.offsetHeight);
      bringToFront(windowEl);
    }

    function restoreWindow(windowEl) {
      if (!windowEl || windowEl.dataset.state !== 'maximized') return;
      windowEl.dataset.state = 'normal';
      const rectRaw = windowEl.dataset.normalRect;
      if (rectRaw) {
        try {
          const rect = JSON.parse(rectRaw);
          windowEl.style.left = `${rect.left}px`;
          windowEl.style.top = `${rect.top}px`;
          windowEl.style.width = `${rect.width}px`;
          windowEl.style.height = `${rect.height}px`;
          windowEl.dataset.userPositioned = 'true';
          windowEl.dataset.userSized = 'true';
          applyWindowContentSizing(windowEl, rect.height);
          saveWindowSize(windowEl);
          bringToFront(windowEl);
          return;
        } catch (e) {
          windowEl.dataset.normalRect = '';
        }
      }
      layoutWindow(windowEl);
      bringToFront(windowEl);
    }

    function toggleMaximize(windowEl) {
      if (!windowEl) return;
      if (windowEl.dataset.state === 'maximized') {
        restoreWindow(windowEl);
      } else {
        maximizeWindow(windowEl);
      }
    }

    function enableDragging() {
      let activeWindow = null;
      let offsetX = 0;
      let offsetY = 0;
      document.querySelectorAll('[data-drag-handle]').forEach((handle) => {
        handle.addEventListener('mousedown', (event) => {
          const windowEl = event.currentTarget.closest('.window');
          if (!windowEl || windowEl.dataset.state === 'maximized') return;
          activeWindow = windowEl;
          const rect = windowEl.getBoundingClientRect();
          offsetX = event.clientX - rect.left;
          offsetY = event.clientY - rect.top;
          windowEl.style.cursor = 'grabbing';
          windowEl.dataset.userPositioned = 'true';
          bringToFront(windowEl);
        });
        handle.addEventListener('dblclick', (event) => {
          const windowEl = event.currentTarget.closest('.window');
          if (!windowEl) return;
          toggleMaximize(windowEl);
        });
      });
      document.addEventListener('mouseup', () => {
        if (activeWindow) activeWindow.style.cursor = 'grab';
        activeWindow = null;
      });
      document.addEventListener('mousemove', (event) => {
        if (!activeWindow) return;
        const bounds = getBounds();
        const left = clamp(event.clientX - bounds.left - offsetX, 20, bounds.width - activeWindow.offsetWidth - 20);
        const top = clamp(event.clientY - bounds.top - offsetY, 20, bounds.height - activeWindow.offsetHeight - 20);
        activeWindow.style.left = `${left}px`;
        activeWindow.style.top = `${top}px`;
      });
    }

    function enableResizing() {
      let activeWindow = null;
      let direction = '';
      let startX = 0;
      let startY = 0;
      let startWidth = 0;
      let startHeight = 0;
      let startLeft = 0;
      let startTop = 0;

      document.querySelectorAll('[data-resize]').forEach((handle) => {
        handle.addEventListener('mousedown', (event) => {
          const windowEl = event.currentTarget.closest('.window');
          if (!windowEl || windowEl.dataset.state === 'maximized') return;
          activeWindow = windowEl;
          direction = event.currentTarget.getAttribute('data-resize');
          startX = event.clientX;
          startY = event.clientY;
          startWidth = windowEl.offsetWidth;
          startHeight = windowEl.offsetHeight;
          startLeft = windowEl.offsetLeft;
          startTop = windowEl.offsetTop;
          windowEl.dataset.userSized = 'true';
          windowEl.dataset.userPositioned = 'true';
          bringToFront(windowEl);
          event.preventDefault();
        });
      });

      document.addEventListener('mousemove', (event) => {
        if (!activeWindow) return;
        const bounds = getBounds();
        const { width: minWidth, height: minHeight } = getDefaultWindowSize(bounds);
        const { width: maxWidth, height: maxHeight } = getMaxWindowSize(bounds);
        let width = startWidth;
        let height = startHeight;
        let left = startLeft;
        let top = startTop;

        const dx = event.clientX - startX;
        const dy = event.clientY - startY;

        if (direction.includes('e')) {
          width = clamp(startWidth + dx, minWidth, maxWidth);
        }
        if (direction.includes('s')) {
          height = clamp(startHeight + dy, minHeight, maxHeight);
        }
        if (direction.includes('w')) {
          width = clamp(startWidth - dx, minWidth, maxWidth);
          left = clamp(startLeft + dx, 20, bounds.width - width - 20);
        }
        if (direction.includes('n')) {
          height = clamp(startHeight - dy, minHeight, maxHeight);
          top = clamp(startTop + dy, 20, bounds.height - height - 20);
        }

        activeWindow.style.width = `${width}px`;
        activeWindow.style.height = `${height}px`;
        activeWindow.style.left = `${left}px`;
        activeWindow.style.top = `${top}px`;
        applyWindowContentSizing(activeWindow, height);
      });

      document.addEventListener('mouseup', () => {
        if (!activeWindow) return;
        saveWindowSize(activeWindow);
        activeWindow = null;
      });
    }

    function enableFocus() {
      windowElements.forEach((win) => {
        win.addEventListener('mousedown', () => bringToFront(win));
      });
    }

    function enableContentSizingObserver() {
      if (typeof ResizeObserver === 'undefined') return;
      const observer = new ResizeObserver((entries) => {
        entries.forEach((entry) => {
          const windowEl = entry.target.closest('.window');
          if (!windowEl || !windowEl.classList.contains('active')) return;
          if (windowEl.dataset.state === 'maximized') return;
          if (windowEl.dataset.userSized === 'true') return;
          fitWindowToContent(windowEl);
          positionWindow(windowEl);
        });
      });

      windowElements.forEach((win) => {
        const content = win.querySelector('.window-content');
        if (content) observer.observe(content);
      });
    }

    document.querySelectorAll('[data-app]').forEach((btn) => {
      btn.addEventListener('click', () => openApp(btn.getAttribute('data-app')));
    });
    document.querySelectorAll('[data-close]').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const windowEl = event.currentTarget.closest('.window');
        closeWindow(windowEl);
      });
    });
    document.querySelectorAll('[data-minimize]').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const windowEl = event.currentTarget.closest('.window');
        minimizeWindow(windowEl);
      });
    });
    document.querySelectorAll('[data-maximize]').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const windowEl = event.currentTarget.closest('.window');
        toggleMaximize(windowEl);
      });
    });

    updateClock();
    setInterval(updateClock, 60000);
    enableDragging();
    enableResizing();
    enableFocus();
    enableContentSizingObserver();
    openApp('home');
    checkHealth();
  </script>
</body>
</html>
